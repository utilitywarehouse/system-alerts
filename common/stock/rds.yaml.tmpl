# PROMETHEUS RULES
# DO NOT REMOVE line above, used in `pre-commit` hook

groups:
  - name: RDS
    rules:
      - alert: LowFreeableMemory
        expr: '(aws_rds_freeable_memory_average{dbinstance_identifier!=""} offset 15m / on(dbinstance_identifier) group_left(team, instance_class) aws_rds_memory_bytes{dbinstance_identifier!=""}) < 0.25'
        for: 15m
        labels:
          alerttype: stock
          alertgroup: RDS
        annotations:
          summary: "RDS instance {{$labels.dbinstance_identifier}} has less than 25% freeable memory"
          impact: "Running out of memory can result in rejected connections"
          action: "Low freeable memory means that there is a spike in database connections or that your instance may be under high memory pressure. Check for memory pressure by monitoring the SwapUsage in addition to FreeableMemory. If the instance memory consumption is frequently too high, this indicates that you should check your workload or upgrade your instance class."
          link: "https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Best_Practice_Recommended_Alarms_AWS_Services.html#RDS"
          dashboard: "<https://grafana.$ENVIRONMENT.$PROVIDER.uw.systems/d/4yyL6dBMk/elasticsearch-overview?orgId=1&refresh=1m&from=now-12h&to=now&var-namespace={{ $labels.namespace }}|link>"
